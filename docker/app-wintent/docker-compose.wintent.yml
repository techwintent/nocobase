version: "3"

networks:
  wintent:
    driver: bridge

services:
  app:
    build:
      context: ../../
      dockerfile: docker/app-wintent/Dockerfile.wintent
    image: wintent/nocobase:2.0.0-alpha.49-wintent
    platform: linux/amd64
    container_name: wintent-app
    networks:
      - wintent
    environment:
      # 应用配置
      - APP_ENV=production
      - APP_KEY=wintent-docker-secure-key-change-in-production
      - ENCRYPTION_FIELD_KEY=wintent-encryption-key-change-in-production
      
      # 数据库配置
      - DB_DIALECT=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=wintent
      - DB_USER=wintent
      - DB_PASSWORD=wintent
      - DB_TIMEZONE=+08:00
      
      # 初始化配置（首次安装时使用）
      - INIT_ROOT_EMAIL=admin@wintent.tech
      - INIT_ROOT_PASSWORD=admin123
      - INIT_ROOT_NICKNAME=Wintent Admin
      - INIT_ROOT_USERNAME=admin
      - INIT_APP_LANG=zh-CN
      
      # 时区配置
      - TZ=Asia/Shanghai
    volumes:
      - ./storage:/app/nocobase/storage
    ports:
      - "13000:13000"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    init: true

  postgres:
    image: postgres:14
    platform: linux/amd64
    container_name: wintent-postgres
    restart: always
    command: postgres -c wal_level=logical
    environment:
      POSTGRES_USER: wintent
      POSTGRES_DB: wintent
      POSTGRES_PASSWORD: wintent
    volumes:
      - ./storage/db/postgres:/var/lib/postgresql/data
    networks:
      - wintent
    ports:
      - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wintent -d wintent"]
      interval: 10s
      timeout: 5s
      retries: 5

